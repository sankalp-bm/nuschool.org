<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Drawing - KidLearn AI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #F0FFFF 60%, #B6E2FF 100%);
            font-family: 'Nunito', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            margin-bottom: 30px;
        }
        .header-bar {
            background: #b57b79 !important;
            border-bottom-left-radius: 0rem;
            border-bottom-right-radius: 0rem;
            height: 58px;
            min-height: 58px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
        }
        .header-bar .menu-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .header-bar h1 {
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto;
        }
        .footer-fixed {
            background: #b57b79 !important;
            border-radius: 0;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
            position: fixed !important;
            bottom: 0; left: 0; right: 0;
            height: 58px;
            min-height: 58px;
            z-index: 100;
            width: 100%;
        }
        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #fff;
            font-weight: 700;
            font-size: 12.65px;
            margin: 0 0.2rem;
            text-decoration: none;
        }
        .footer-btn .material-icons {
            background: #b57b79;
            color: #fff;
            border-radius: 50%;
            padding: 1.15rem;
            font-size: 1.1rem;
            margin-bottom: 0.1rem;
        }
        .footer-btn.active { color: #fff; }
        .footer-btn.active .material-icons {
            background: #b57b79;
            color: #fff;
        }
        main {
            flex: 1 0 auto;
            padding-bottom: 90px;
            margin-top: 68px;
        }
        .section-card { background: #fff; border-radius: 2rem; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 2rem 1rem 1.5rem 1rem; margin: 2rem auto; max-width: 700px; }
        .section-title { font-size: 1.5rem !important; font-weight: 800; display: flex; align-items: center; margin-bottom: 1.5rem; color: #39b6ff; }
        .section-title .section-icon { font-size: 2rem !important; margin-right: 0.75rem; }
        .toolbar {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            align-items: center;
            border: none !important;
            padding: 0.5rem 0 !important;
        }
        .toolbar label { font-weight: 600; margin-right: 0.5rem; }
        .toolbar input[type='color'] { border: none; width: 2rem; height: 2rem; border-radius: 50%; }
        .toolbar select, .toolbar input[type='range'] { border-radius: 0.5rem; padding: 0.25rem 0.5rem; }
        .toolbar button {
            background: #6fd0ff;
            color: #fff;
            border: none;
            border-radius: 0.75rem;
            padding: 0.4rem 0.8rem;
            font-weight: 700;
            margin-right: 0.5rem;
            transition: background 0.2s;
            cursor: pointer;
        }
        .toolbar button.active, .toolbar button:hover { background: #39b6ff; }
        .drawing-board {
            width: 668px;
            height: 400px;
            border: 2px solid #e0e0e0;
            margin: 20px auto;
            position: relative;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        canvas {
            width: 668px;
            height: 400px;
            background: #fff;
            display: block;
            cursor: crosshair;
        }
        /* Add a subtle grid background */
        .drawing-board::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 1;
        }
        /* Add a subtle hover effect */
        .drawing-board:hover {
            border-color: #6fd0ff;
            box-shadow: 0 6px 16px rgba(111,208,255,0.2);
        }
        .tool-btn span.material-icons { transition: color 0.1s; }
        .tool-btn.active span.material-icons { color: #003366 !important; }
        .tool-btn[title]:hover:after, .tool-btn[title]:focus:after {
            content: attr(title);
            position: absolute;
            background: #003366;
            color: #fff;
            font-size: 0.85rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.5rem;
            left: 50%;
            top: -2.2rem;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 10;
            opacity: 1;
            pointer-events: none;
            transition: none;
        }
        .tool-btn[title] { position: relative; }
        .toolbar { overflow-y: hidden !important; }
        .toolbar-scroll::-webkit-scrollbar {
            height: 4px;
        }
        .toolbar-scroll::-webkit-scrollbar-thumb {
            background: #b3e0ff;
            border-radius: 2px;
        }
        .toolbar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        .tool-btn.active#tool-eraser {
            background: linear-gradient(45deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        .tool-btn.active#tool-eraser::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff0000, #00ff00, #0000ff, #ffff00, #ff00ff);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
            border-radius: 0.75rem;
            z-index: -1;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Custom cursors for different tools */
        canvas[data-tool="brush"],
        canvas[data-tool="pencil"] { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23000" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24, auto; }

        canvas[data-tool="eraser"] { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23000" d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.78-.78 2.04 0 2.82l4.24 4.24c.78.78 2.04.78 2.82 0L20.73 10.27c.39-.39.59-.9.59-1.41 0-.51-.2-1.02-.59-1.41L16.55 3.59c-.39-.39-.9-.59-1.41-.59zM14 15l-2 2H6l-4-4 2-2 4 4 6-6z"/></svg>') 0 24, auto; }

        canvas[data-tool="fill"] { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23000" d="M16.56 8.94L7.62 0 6.21 1.41l2.38 2.38-5.15 5.15c-.59.59-.59 1.54 0 2.12l5.5 5.5c.29.29.68.44 1.06.44s.77-.15 1.06-.44l5.5-5.5c.59-.58.59-1.53 0-2.12zM5.21 10L10 5.21 14.79 10H5.21zM19 11.5s-2 2.17-2 3.5c0 1.1.9 2 2 2s2-.9 2-2c0-1.33-2-3.5-2-3.5z"/></svg>') 0 24, auto; }

        canvas[data-tool="magnifier"] { cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%23000" d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>') 0 24, auto; }

        canvas[data-tool="text"] { cursor: text; }

        canvas[data-tool="select"] { cursor: crosshair; }
    </style>
</head>
<body>
    <header class="header-bar" style="position: relative;">
        <button class="menu-btn" aria-label="Menu" onclick="toggleMenuDropdown(event)">
            <span class="material-icons">menu</span>
        </button>
        <h1>Create Drawing</h1>
        <div id="menuDropdown" style="display:none; position:absolute; left:1rem; top:58px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.12); border-radius:0.5rem; min-width:140px; z-index:200;">
            <a href="/contact.html" style="display:block; padding:0.75rem 1.25rem; color:#2196f3; text-decoration:none; font-weight:600; border-bottom:1px solid #eee;">Contact Us</a>
            <a href="/login.html" style="display:block; padding:0.75rem 1.25rem; color:#e53935; text-decoration:none; font-weight:600;">Logout</a>
        </div>
    </header>

    <main>
        <section class="section-card">
            <div id="toolSummary" style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem; font-weight: 700; font-size: 1.1rem;">
                <span id="summaryTool" style="display: flex; align-items: center; gap: 0.3rem;"><span class="material-icons" id="summaryToolIcon">edit</span><span id="summaryToolName">Pencil</span></span>
                <span>Color: <span id="summaryColorName">Black</span></span>
                <span>Size: <span id="summarySize">4</span></span>
            </div>
            <div class="toolbar toolbar-scroll" style="margin-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; overflow-x: auto; width: 100%; white-space: nowrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="tool-pencil" class="tool-btn active" onclick="setTool('pencil')" title="Pencil"><span class="material-icons">edit</span></button>
                    <button id="tool-brush" class="tool-btn" onclick="setTool('brush')" title="Brush"><span class="material-icons">brush</span></button>
                    <button id="tool-airbrush" class="tool-btn" onclick="setTool('airbrush')" title="Airbrush"><span class="material-icons">blur_on</span></button>
                    <button id="tool-eraser" class="tool-btn" onclick="setTool('eraser')" title="Eraser"><span class="material-icons">auto_fix_normal</span></button>
                    <button id="tool-fill" class="tool-btn" onclick="setTool('fill')" title="Fill with Color"><span class="material-icons">format_color_fill</span></button>
                    <button id="tool-magnifier" class="tool-btn" onclick="setTool('magnifier')" title="Magnifier"><span class="material-icons">search</span></button>
                    <button id="tool-text" class="tool-btn" onclick="setTool('text')" title="Text"><span class="material-icons">title</span></button>
                    <button id="tool-select" class="tool-btn" onclick="setTool('select')" title="Selection Tool"><span class="material-icons">select_all</span></button>
                </div>
            </div>
            <div class="toolbar toolbar-scroll" style="margin-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; overflow-x: auto; width: 100%; white-space: nowrap;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button id="tool-circle" class="tool-btn" onclick="setTool('circle')" title="Circle"><span class="material-icons">circle</span></button>
                    <button id="tool-square" class="tool-btn" onclick="setTool('square')" title="Square"><span class="material-icons">crop_square</span></button>
                    <button id="tool-rect" class="tool-btn" onclick="setTool('rect')" title="Rectangle"><span class="material-icons">rectangle</span></button>
                    <button id="tool-triangle" class="tool-btn" onclick="setTool('triangle')" title="Triangle"><span class="material-icons">change_history</span></button>
                    <button id="tool-oval" class="tool-btn" onclick="setTool('oval')" title="Oval"><span class="material-icons">panorama_fish_eye</span></button>
                    <button id="tool-pentagon" class="tool-btn" onclick="setTool('pentagon')" title="Pentagon"><span class="material-icons">pentagon</span></button>
                    <button id="tool-hexagon" class="tool-btn" onclick="setTool('hexagon')" title="Hexagon"><span class="material-icons">hexagon</span></button>
                    <button id="tool-heptagon" class="tool-btn" onclick="setTool('heptagon')" title="Heptagon"><span class="material-icons">7k</span></button>
                    <button id="tool-octagon" class="tool-btn" onclick="setTool('octagon')" title="Octagon"><span class="material-icons">8k</span></button>
                    <button id="tool-nonagon" class="tool-btn" onclick="setTool('nonagon')" title="Nonagon"><span class="material-icons">9k</span></button>
                    <button id="tool-decagon" class="tool-btn" onclick="setTool('decagon')" title="Decagon"><span class="material-icons">10k</span></button>
                    <button id="tool-ellipse" class="tool-btn" onclick="setTool('ellipse')" title="Ellipse"><span class="material-icons">panorama_fish_eye</span></button>
                    <button id="tool-rhombus" class="tool-btn" onclick="setTool('rhombus')" title="Rhombus"><span class="material-icons">diamond</span></button>
                    <button id="tool-trapezoid" class="tool-btn" onclick="setTool('trapezoid')" title="Trapezoid"><span class="material-icons">filter_frames</span></button>
                    <button id="tool-parallelogram" class="tool-btn" onclick="setTool('parallelogram')" title="Parallelogram"><span class="material-icons">crop_16_9</span></button>
                    <button id="tool-kite" class="tool-btn" onclick="setTool('kite')" title="Kite"><span class="material-icons">air</span></button>
                    <button id="tool-rhomboid" class="tool-btn" onclick="setTool('rhomboid')" title="Rhomboid"><span class="material-icons">diamond</span></button>
                    <button id="tool-star" class="tool-btn" onclick="setTool('star')" title="Star"><span class="material-icons">star</span></button>
                    <button id="tool-crescent" class="tool-btn" onclick="setTool('crescent')" title="Crescent"><span class="material-icons">nightlight</span></button>
                    <button id="tool-heart" class="tool-btn" onclick="setTool('heart')" title="Heart"><span class="material-icons">favorite</span></button>
                </div>
            </div>
            <div class="toolbar" style="margin-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">
                <!-- Color & Size -->
                <label>Color <input type="color" id="colorPicker" value="#222222" onchange="setColor(this.value)"></label>
                <label>Size <input type="range" id="sizePicker" min="2" max="32" value="4" onchange="setSize(this.value)"></label>
            </div>
            <div class="drawing-board">
                <canvas id="drawingCanvas" width="360" height="640"></canvas>
            </div>
            <div class="toolbar" style="margin-top: 1rem; justify-content: center; border-top: 2px solid #e0e0e0; padding-top: 0.5rem;">
                <button onclick="openDrawing()"><span class="material-icons">folder_open</span> Open</button>
                <button onclick="saveDrawing()"><span class="material-icons">save</span> Save</button>
                <button onclick="downloadDrawing()"><span class="material-icons">download</span> Download</button>
                <button onclick="clearCanvas()"><span class="material-icons">delete</span> Clear</button>
            </div>
        </section>
    </main>

    <footer class="footer-fixed shadow flex justify-around items-center">
        <a href="javascript:history.back()" class="footer-btn"><span class="material-icons">arrow_back</span>Back</a>
        <a href="/home.html" class="footer-btn active"><span class="material-icons">home</span>Home</a>
        <a href="/gallery.html" class="footer-btn"><span class="material-icons">photo_library</span>Gallery</a>
    </footer>

    <script>
    // Drawing state
    let tool = 'brush';
    let color = '#000000';
    let size = 2;
    let drawing = false;
    let startX, startY;
    let savedImageData;
    let textInput = null;
    let magnifierScale = 1;
    let selection = null;
    let airbrushInterval = null;

    const toolNames = {
        pencil: 'Pencil', brush: 'Brush', airbrush: 'Airbrush', eraser: 'Eraser', fill: 'Fill', magnifier: 'Magnifier', text: 'Text', select: 'Selection',
        circle: 'Circle', square: 'Square', rect: 'Rectangle', triangle: 'Triangle', oval: 'Oval', pentagon: 'Pentagon', hexagon: 'Hexagon', heptagon: 'Heptagon', octagon: 'Octagon', nonagon: 'Nonagon', decagon: 'Decagon', ellipse: 'Ellipse', rhombus: 'Rhombus', trapezoid: 'Trapezoid', parallelogram: 'Parallelogram', kite: 'Kite', rhomboid: 'Rhomboid', star: 'Star', crescent: 'Crescent', heart: 'Heart', line: 'Line'
    };
    const toolIcons = {
        pencil: 'edit', brush: 'brush', airbrush: 'blur_on', eraser: 'auto_fix_normal', fill: 'format_color_fill', magnifier: 'search', text: 'title', select: 'select_all',
        circle: 'circle', square: 'crop_square', rect: 'rectangle', triangle: 'change_history', oval: 'panorama_fish_eye', pentagon: 'pentagon', hexagon: 'hexagon', heptagon: '7k', octagon: '8k', nonagon: '9k', decagon: '10k', ellipse: 'panorama_fish_eye', rhombus: 'diamond', trapezoid: 'filter_frames', parallelogram: 'crop_16_9', kite: 'air', rhomboid: 'diamond', star: 'star', crescent: 'nightlight', heart: 'favorite', line: 'show_chart'
    };
    function getColorName(hex) {
        const colors = {
            '#000000': 'Black', '#222222': 'Black', '#ffffff': 'White', '#ff0000': 'Red', '#00ff00': 'Lime', '#0000ff': 'Blue',
            '#ffff00': 'Yellow', '#00ffff': 'Cyan', '#ff00ff': 'Magenta', '#808080': 'Gray', '#c0c0c0': 'Silver', '#800000': 'Maroon',
            '#808000': 'Olive', '#008000': 'Green', '#800080': 'Purple', '#008080': 'Teal', '#b3e0ff': 'Light Blue', '#6fd0ff': 'Sky Blue',
        };
        hex = hex.toLowerCase();
        if (colors[hex]) return colors[hex];
        // Try to match short hex
        if (hex.length === 7 && colors[hex.slice(0, 4) + hex.slice(4)]) return colors[hex.slice(0, 4) + hex.slice(4)];
        return hex;
    }
    function updateToolSummary() {
        document.getElementById('summaryToolIcon').textContent = toolIcons[tool] || 'edit';
        document.getElementById('summaryToolName').textContent = toolNames[tool] || tool;
        document.getElementById('summaryColorName').textContent = getColorName(color);
        document.getElementById('summarySize').textContent = size;
    }
    function setTool(t) {
        tool = t;
        canvas.setAttribute('data-tool', t);
        updateToolSummary();
        // Clear any active intervals
        if (airbrushInterval) {
            clearInterval(airbrushInterval);
            airbrushInterval = null;
        }
    }
    function setColor(c) { color = c; updateToolSummary(); }
    function setSize(s) { size = s; updateToolSummary(); }
    function initCanvas() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        
        // Set canvas dimensions
        canvas.width = 668;
        canvas.height = 400;
        
        // Set default styles
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = color;
        ctx.lineWidth = size;
        
        // Initialize with white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Add event listeners
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('mouseleave', endDraw);
        
        // Touch support
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            startDraw({ offsetX: x, offsetY: y });
        });
        
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            draw({ offsetX: x, offsetY: y });
        });
        
        canvas.addEventListener('touchend', endDraw);
        
        // Initialize tool summary
        updateToolSummary();
    }
    function startDraw(e) {
        drawing = true;
        startX = e.offsetX;
        startY = e.offsetY;
        
        if (tool === 'brush' || tool === 'pencil' || tool === 'eraser') {
            ctx.beginPath();
            ctx.moveTo(startX, startY);
        } else if (tool === 'rect' || tool === 'circle' || tool === 'line' || 
                   tool === 'triangle' || tool === 'oval' || tool === 'pentagon' || 
                   tool === 'hexagon' || tool === 'heptagon' || tool === 'octagon' || 
                   tool === 'nonagon' || tool === 'decagon' || tool === 'ellipse' || 
                   tool === 'rhombus' || tool === 'trapezoid' || tool === 'parallelogram' || 
                   tool === 'kite' || tool === 'rhomboid' || tool === 'star' || 
                   tool === 'crescent' || tool === 'heart') {
            savedImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
    }
    function draw(e) {
        if (!drawing) return;
        
        const x = e.offsetX;
        const y = e.offsetY;
        
        switch(tool) {
            case 'brush':
            case 'pencil':
                ctx.strokeStyle = tool === 'eraser' ? '#ffffff' : color;
            ctx.lineWidth = size;
            ctx.lineTo(x, y);
            ctx.stroke();
                break;
                
            case 'eraser':
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = size;
            ctx.lineTo(x, y);
            ctx.stroke();
                break;
                
            case 'airbrush':
                if (!airbrushInterval) {
                    airbrushInterval = setInterval(() => {
                        for (let i = 0; i < 10; i++) {
                            const offsetX = (Math.random() - 0.5) * size * 2;
                            const offsetY = (Math.random() - 0.5) * size * 2;
                            ctx.fillStyle = color;
                            ctx.beginPath();
                            ctx.arc(x + offsetX, y + offsetY, size/4, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }, 16); // Increased frequency for smoother effect
                }
                break;
                
            case 'fill':
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                const startPos = (y * canvas.width + x) * 4;
                const startR = pixels[startPos];
                const startG = pixels[startPos + 1];
                const startB = pixels[startPos + 2];
                
                const fillColor = hexToRgb(color);
                if (!fillColor) return;
                
                if (startR === fillColor.r && startG === fillColor.g && startB === fillColor.b) return;
                
                const stack = [[x, y]];
                const visited = new Set();
                
                while (stack.length) {
                    const [px, py] = stack.pop();
                    const pos = (py * canvas.width + px) * 4;
                    const key = `${px},${py}`;
                    
                    if (px < 0 || px >= canvas.width || py < 0 || py >= canvas.height) continue;
                    if (visited.has(key)) continue;
                    if (pixels[pos] !== startR || pixels[pos + 1] !== startG || pixels[pos + 2] !== startB) continue;
                    
                    visited.add(key);
                    pixels[pos] = fillColor.r;
                    pixels[pos + 1] = fillColor.g;
                    pixels[pos + 2] = fillColor.b;
                    pixels[pos + 3] = 255;
                    
                    stack.push([px + 1, py], [px - 1, py], [px, py + 1], [px, py - 1]);
                }
                
                ctx.putImageData(imageData, 0, 0);
                break;
                
            case 'magnifier':
                if (magnifierScale < 4) {
                    magnifierScale *= 1.1;
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.scale(magnifierScale, magnifierScale);
                    ctx.translate(-x, -y);
                    ctx.drawImage(canvas, 0, 0);
                    ctx.restore();
                }
                break;
                
            case 'text':
                if (!textInput) {
                    textInput = document.createElement('input');
                    textInput.type = 'text';
                    textInput.style.position = 'absolute';
                    textInput.style.left = (canvas.offsetLeft + x) + 'px';
                    textInput.style.top = (canvas.offsetTop + y) + 'px';
                    textInput.style.color = color;
                    textInput.style.fontSize = size * 5 + 'px';
                    textInput.style.background = 'transparent';
                    textInput.style.border = 'none';
                    textInput.style.outline = 'none';
                    textInput.style.padding = '0';
                    textInput.style.margin = '0';
                    textInput.style.fontFamily = 'Arial';
                    
                    textInput.onblur = function() {
                        ctx.font = size * 5 + 'px Arial';
                        ctx.fillStyle = color;
                        ctx.fillText(this.value, x, y);
                        this.remove();
                        textInput = null;
                    };
                    
                    document.body.appendChild(textInput);
                    textInput.focus();
                }
                break;
                
            case 'select':
                if (!selection) {
                    selection = { x: x, y: y, width: 0, height: 0 };
                } else {
                    selection.width = x - selection.x;
                    selection.height = y - selection.y;
                    ctx.putImageData(savedImageData, 0, 0);
                    ctx.strokeStyle = '#000';
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(selection.x, selection.y, selection.width, selection.height);
                    ctx.setLineDash([]);
                }
                break;
                
            default:
                if (savedImageData) {
            ctx.putImageData(savedImageData, 0, 0);
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
                    drawShape(tool, startX, startY, x, y);
                }
                break;
        }
    }
    function drawShape(shape, x1, y1, x2, y2) {
        const width = x2 - x1;
        const height = y2 - y1;
        
                ctx.beginPath();
        switch(shape) {
            case 'square':
                const squareSize = Math.max(Math.abs(width), Math.abs(height));
                ctx.strokeRect(x1, y1, squareSize, squareSize);
                break;
                
            case 'crescent':
                const crescentCenterX = x1 + width/2;
                const crescentCenterY = y1 + height/2;
                const radius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                ctx.arc(crescentCenterX, crescentCenterY, radius, 0, Math.PI * 2);
                ctx.arc(crescentCenterX + radius/2, crescentCenterY, radius/2, 0, Math.PI * 2, true);
                ctx.stroke();
                break;
                
            case 'heart':
                const heartCenterX = x1 + width/2;
                const heartCenterY = y1 + height/2;
                const heartSize = Math.min(Math.abs(width), Math.abs(height)) / 2;
                ctx.moveTo(heartCenterX, heartCenterY + heartSize/2);
                ctx.bezierCurveTo(
                    heartCenterX, heartCenterY + heartSize,
                    heartCenterX - heartSize, heartCenterY + heartSize,
                    heartCenterX - heartSize, heartCenterY
                );
                ctx.bezierCurveTo(
                    heartCenterX - heartSize, heartCenterY - heartSize,
                    heartCenterX, heartCenterY - heartSize,
                    heartCenterX, heartCenterY
                );
                ctx.bezierCurveTo(
                    heartCenterX, heartCenterY - heartSize,
                    heartCenterX + heartSize, heartCenterY - heartSize,
                    heartCenterX + heartSize, heartCenterY
                );
                ctx.bezierCurveTo(
                    heartCenterX + heartSize, heartCenterY + heartSize,
                    heartCenterX, heartCenterY + heartSize,
                    heartCenterX, heartCenterY + heartSize/2
                );
                ctx.stroke();
                break;
                
            case 'rect':
                ctx.strokeRect(x1, y1, width, height);
                break;
            case 'circle':
                const circleRadius = Math.sqrt(width * width + height * height);
                ctx.arc(x1, y1, circleRadius, 0, Math.PI * 2);
                ctx.stroke();
                break;
            case 'line':
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
                break;
            case 'triangle':
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineTo(x1 - width, y2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'oval':
            case 'ellipse':
                ctx.ellipse(x1 + width/2, y1 + height/2, Math.abs(width/2), Math.abs(height/2), 0, 0, Math.PI * 2);
                ctx.stroke();
                break;
            case 'pentagon':
            case 'hexagon':
            case 'heptagon':
            case 'octagon':
            case 'nonagon':
            case 'decagon':
                const sides = {
                    'pentagon': 5, 'hexagon': 6, 'heptagon': 7,
                    'octagon': 8, 'nonagon': 9, 'decagon': 10
                }[shape];
                const polygonCenterX = x1 + width/2;
                const polygonCenterY = y1 + height/2;
                const polygonRadius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                for (let i = 0; i < sides; i++) {
                    const angle = (i * 2 * Math.PI / sides) - Math.PI/2;
                    const x = polygonCenterX + polygonRadius * Math.cos(angle);
                    const y = polygonCenterY + polygonRadius * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
                break;
            case 'rhombus':
                ctx.moveTo(x1 + width/2, y1);
                ctx.lineTo(x2, y1 + height/2);
                ctx.lineTo(x1 + width/2, y2);
                ctx.lineTo(x1, y1 + height/2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'trapezoid':
                ctx.moveTo(x1 + width/4, y1);
                ctx.lineTo(x2 - width/4, y1);
                ctx.lineTo(x2, y2);
                ctx.lineTo(x1, y2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'parallelogram':
                ctx.moveTo(x1 + width/4, y1);
                ctx.lineTo(x2, y1);
                ctx.lineTo(x2 - width/4, y2);
                ctx.lineTo(x1, y2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'kite':
                ctx.moveTo(x1 + width/2, y1);
                ctx.lineTo(x2, y1 + height/2);
                ctx.lineTo(x1 + width/2, y2);
                ctx.lineTo(x1, y1 + height/2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'rhomboid':
                ctx.moveTo(x1 + width/4, y1);
                ctx.lineTo(x2, y1);
                ctx.lineTo(x2 - width/4, y2);
                ctx.lineTo(x1, y2);
                ctx.closePath();
                ctx.stroke();
                break;
            case 'star':
                const spikes = 5;
                const outerRadius = Math.min(Math.abs(width), Math.abs(height)) / 2;
                const innerRadius = outerRadius / 2;
                const starCenterX = x1 + width/2;
                const starCenterY = y1 + height/2;
                for (let i = 0; i < spikes * 2; i++) {
                    const radius = i % 2 === 0 ? outerRadius : innerRadius;
                    const angle = (i * Math.PI / spikes) - Math.PI/2;
                    const x = starCenterX + radius * Math.cos(angle);
                    const y = starCenterY + radius * Math.sin(angle);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
                break;
        }
    }
    function endDraw() {
        if (!drawing) return;
        drawing = false;
        if (airbrushInterval) {
            clearInterval(airbrushInterval);
            airbrushInterval = null;
        }
        if (tool === 'brush' || tool === 'eraser') {
            ctx.closePath();
        }
        selection = null;
    }
    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function saveDrawing() {
        let data = canvas.toDataURL('image/png');
        let gallery = JSON.parse(localStorage.getItem('gallery') || '[]');
        const drawingId = Date.now().toString();
        gallery.push({ 
            id: drawingId,
            img: data, 
            date: new Date().toISOString(),
            editable: true
        });
        localStorage.setItem('gallery', JSON.stringify(gallery));
        alert('Drawing saved to Gallery!');
    }
    function downloadDrawing() {
        // Create a temporary canvas with white background
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fill with white background
        tempCtx.fillStyle = '#ffffff';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Draw the original canvas content
        tempCtx.drawImage(canvas, 0, 0);
        
        // Create download link
        let link = document.createElement('a');
        link.download = 'drawing.png';
        link.href = tempCanvas.toDataURL('image/png');
        link.click();
    }
    function openDrawing() {
        let input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function(e) {
            let file = e.target.files[0];
            if (!file) return;
            let reader = new FileReader();
            reader.onload = function(evt) {
                let img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }
    // Menu dropdown logic
    function toggleMenuDropdown(event) {
        event.stopPropagation();
        var dropdown = document.getElementById('menuDropdown');
        if (dropdown.style.display === 'none' || dropdown.style.display === '') {
            dropdown.style.display = 'block';
            document.addEventListener('click', closeMenuDropdown);
        } else {
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeMenuDropdown);
        }
    }
    function closeMenuDropdown(e) {
        var dropdown = document.getElementById('menuDropdown');
        if (!dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            document.removeEventListener('click', closeMenuDropdown);
        }
    }
    // Helper function to convert hex color to RGB
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
    </script>
    <script>
        // Initialize canvas when the page loads
        window.onload = function() {
            initCanvas();
        };
    </script>
</body>
</html> 